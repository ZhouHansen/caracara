(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{144:function(e,t,n){"use strict";(function(e){var a=n(61),r=n(16),o=n.n(r),s=n(33),i=n(84),c=n(24),u=n(25),l=n(28),p=n(26),m=n(27),d=n(203),h=n(15),f=n(204).Writable,b=n(209),g=n(102),v=n(262)(),y=function(e){function t(e,n){var a;return Object(c.a)(this,t),n||(n=e,e={}),(a=Object(l.a)(this,Object(p.a)(t).call(this,e))).cb=n,a}return Object(m.a)(t,e),Object(u.a)(t,[{key:"_write",value:function(e,t,n){this.cb(e,t,n)}}]),t}(f),k=function(t){function n(e,t,a){var r;return Object(c.a)(this,n),(r=Object(l.a)(this,Object(p.a)(n).call(this))).operations=new Map,r.newestOperations=[],r.users=new Map,r.username=a,r.timestamp=Date.now(),r.doc=d.init(),r.db=b(e,t,{valueEncoding:"json"}),r}return Object(m.a)(n,t),Object(u.a)(n,[{key:"initialize",value:function(){var e=Object(s.a)(o.a.mark(function e(){return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._ready();case 2:this._updateHistory(this._watchForOperations.bind(this));case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"writeMessage",value:function(e){var t=this,n="operations/".concat(v()),a={key:n,message:e,username:this.username,timestamp:Date.now()};return new Promise(function(e,r){t.db.put(n,a,function(t){t?r(t):e(n)})})}},{key:"replicate",value:function(){return this.db.replicate({live:!0,userData:JSON.stringify({key:this.db.local.key,username:this.username,timestamp:this.timestamp})})}},{key:"connect",value:function(){var t=Object(s.a)(o.a.mark(function t(n){var a,r,s,i=this;return o.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n.remoteUserData){t.next=2;break}throw new Error("peer does not have userData");case 2:return a=JSON.parse(n.remoteUserData),r=e.from(a.key),s=a.username,t.next=7,this._authorize(r);case 7:this.users.has(s)||(this.users.set(s,new Date),this.emit("join",a),n.on("close",function(){i.users.has(s)&&(i.users.delete(s),i.emit("leave",a))}));case 8:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"_authorize",value:function(e){var t=this;return new Promise(function(n,a){t.db.authorized(e,function(r,o){return r?a(r):o?n():void t.db.authorize(e,function(e){if(e)return a(e);n()})})})}},{key:"_updateHistory",value:function(e){var t=this,n=this.db.createHistoryStream({reverse:!0});this.newestOperations=[];var r=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Object(i.a)(y,t)}({objectMode:!0},function(e,n,a){var r=e.key;e.value;/operations/.test(r)&&(console.log("check if operations has key ".concat(r)),t.operations.has(r)?console.log("Destroying history stream - operation found with key ".concat(r)):(console.log("Adding new operation key ".concat(r)),t.newestOperations.push(e))),a()});g(n,r,function(n){t.newestOperations.length;t.newestOperations.reverse().map(function(e,n){console.log("aplicando operaciones nuevas");var r=e.key,o=e.value,s=o.message.peerValue,i=(s.text,s.operation),c="".concat(o.username," ").concat("DELETE"===i?"removed":"added"," some text - \u231a\ufe0f ").concat(o.timestamp),u=d.change(t.doc,c,function(e){return e.text=new d.Text,e.text.insertAt(0,o.message.peerValue.text),e}),l=d.getHistory(u).map(function(e){return[e.change.message,e.snapshot.text]});t.emit("message",Object(a.a)({},o,{text:u.text.join(""),history:l}),r),t.operations.set(e.key,e.value)}),e&&e(n)})}},{key:"_watchForOperations",value:function(){var e=this;this.db.watch("operations",function(){e._updateHistory()})}},{key:"_ready",value:function(){var e=this;return new Promise(function(t){return e.db.ready(t)})}}]),n}(h);t.a=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Object(i.a)(k,t)}}).call(this,n(4).Buffer)},151:function(e,t,n){e.exports=n(372)},156:function(e,t,n){},188:function(e,t){},190:function(e,t){},202:function(e,t){},229:function(e,t){},368:function(e,t,n){},372:function(e,t,n){"use strict";n.r(t);var a=n(1),r=n.n(a),o=n(37),s=n.n(o),i=(n(156),n(20)),c=n(60),u=n(24),l=n(25),p=n(28),m=n(26),d=n(27),h=n(16),f=n.n(h),b=n(33),g=n(150),v=n(374),y=n(375),k=n(140),w=n.n(k),O=n(141),j=n.n(O),E=n(142),x=n.n(E),_=n(143),S=n.n(_),A=n(144),V={SIGNAL_URLS:"wss://signalhubws-olaf.glitch.me",ICE_URLS:"stun:stun.l.google.com:19302;stun:stun1.l.google.com:19302;stun:stun2.l.google.com:19302;stun:stun3.l.google.com:19302;stun:stun4.l.google.com:19302;stun:stun.ekiga.net;turn:numb.viagenie.ca,muazkh,webrtc@live.com;turn:192.158.29.39:3478?transport=udp,JZEOEt2V3Qb0y27GRntt2u2PAYA=,28224511:1379330808;turn:192.158.29.39:3478?transport=tcp,JZEOEt2V3Qb0y27GRntt2u2PAYA=,28224511:1379330808;turn:turn.bistri.com:80,homeo,homeo;turn:turn.anyfirewall.com:443?transport=tcp,webrtc,webrtc"},C=n(61),M=n(46),U=(n(371),n(12)),L=n.n(U);L.a.languages.markdown=L.a.languages.extend("markup",{}),L.a.languages.insertBefore("markdown","prolog",{blockquote:{pattern:/^>(?:[\t ]*>)*/m,alias:"punctuation"},code:[{pattern:/^(?: {4}|\t).+/m,alias:"keyword"},{pattern:/``.+?``|`[^`\n]+`/,alias:"keyword"}],title:[{pattern:/\w+.*(?:\r?\n|\r)(?:==+|--+)/,alias:"important",inside:{punctuation:/==+$|--+$/}},{pattern:/(^\s*)#+.+/m,lookbehind:!0,alias:"important",inside:{punctuation:/^#+|#+$/}}],hr:{pattern:/(^\s*)([*-])([\t ]*\2){2,}(?=\s*$)/m,lookbehind:!0,alias:"punctuation"},list:{pattern:/(^\s*)(?:[*+-]|\d+\.)(?=[\t ].)/m,lookbehind:!0,alias:"punctuation"},"url-reference":{pattern:/!?\[[^\]]+\]:[\t ]+(?:\S+|<(?:\\.|[^>\\])+>)(?:[\t ]+(?:"(?:\\.|[^"\\])*"|'(?:\\.|[^'\\])*'|\((?:\\.|[^)\\])*\)))?/,inside:{variable:{pattern:/^(!?\[)[^\]]+/,lookbehind:!0},string:/(?:"(?:\\.|[^"\\])*"|'(?:\\.|[^'\\])*'|\((?:\\.|[^)\\])*\))$/,punctuation:/^[\[\]!:]|[<>]/},alias:"url"},bold:{pattern:/(^|[^\\])(\*\*|__)(?:(?:\r?\n|\r)(?!\r?\n|\r)|.)+?\2/,lookbehind:!0,inside:{punctuation:/^\*\*|^__|\*\*$|__$/}},italic:{pattern:/(^|[^\\])([*_])(?:(?:\r?\n|\r)(?!\r?\n|\r)|.)+?\2/,lookbehind:!0,inside:{punctuation:/^[*_]|[*_]$/}},url:{pattern:/!?\[[^\]]+\](?:\([^\s)]+(?:[\t ]+"(?:\\.|[^"\\])*")?\)| ?\[[^\]\n]*\])/,inside:{variable:{pattern:/(!?\[)[^\]]+(?=\]$)/,lookbehind:!0},string:{pattern:/"(?:\\.|[^"\\])*"(?=\)$)/}}}}),L.a.languages.markdown.bold.inside.url=L.a.util.clone(L.a.languages.markdown.url),L.a.languages.markdown.italic.inside.url=L.a.util.clone(L.a.languages.markdown.url),L.a.languages.markdown.bold.inside.italic=L.a.util.clone(L.a.languages.markdown.italic),L.a.languages.markdown.italic.inside.bold=L.a.util.clone(L.a.languages.markdown.bold);M.a.deserialize("Slate is flexible enough to add **decorations** that can format text based on its content. For example, this editor has **Markdown** preview decorations on it, to make it _dead_ simple to make an editor with built-in Markdown previewing.\n## Try it out!\nTry it out for yourself!");var I=function(e){function t(e){var n;return Object(u.a)(this,t),(n=Object(p.a)(this,Object(m.a)(t).call(this,e))).ref=function(e){n.editor=e},n.simpleOnChange=function(e){var t=e.target.value;n.setState({value:t})},n.onKey=function(e){n.setState({lastKeyPress:e.key.toUpperCase()})},n.onChange=function(e){var t=e.operations.filter(function(e){return"set_selection"!=e.type&&"set_value"!=e.type&&(!e.data||!e.data.has("source"))}).toJS().map(function(e){return Object(C.a)({},e,{data:{source:n.props.username}})});n.props.updatePeerValue(t)},n.applyOperations=function(e){n.remote=!0,e.forEach(function(e){return n.editor.applyOperation(e)}),n.remote=!1},n.renderMark=function(e,t,n){var a=e.children,o=e.mark,s=e.attributes;switch(o.type){case"bold":return r.a.createElement("strong",s,a);case"code":return r.a.createElement("code",s,a);case"italic":return r.a.createElement("em",s,a);case"underlined":return r.a.createElement("u",s,a);case"title":return r.a.createElement("span",Object.assign({},s,{style:{fontWeight:"bold",fontSize:"20px",margin:"20px 0 10px 0",display:"inline-block"}}),a);case"punctuation":return r.a.createElement("span",Object.assign({},s,{style:{opacity:.2}}),a);case"list":return r.a.createElement("span",Object.assign({},s,{style:{paddingLeft:"10px",lineHeight:"10px",fontSize:"20px"}}),a);case"hr":return r.a.createElement("span",Object.assign({},s,{style:{borderBottom:"2px solid #000",display:"block",opacity:.2}}),a);default:return n()}},n.state={value:e.peerValue.text||"",lastKeyPress:null},n}return Object(d.a)(t,e),Object(l.a)(t,[{key:"componentDidUpdate",value:function(e,t){var n=this.state,a=n.value,r=n.lastKeyPress;if(t.value!==a){var o="ADD";"BACKSPACE"===r&&(o="DELETE");var s={text:a,operation:o};this.props.updatePeerValue(s)}}},{key:"render",value:function(){return r.a.createElement("textarea",{value:this.props.peerValue.text,onChange:this.simpleOnChange,onKeyUp:this.onKey,cols:120,rows:80,autoComplete:"off",autoFocus:!0})}},{key:"decorateNode",value:function(e,t,n){var a=n()||[];if("block"!==e.object)return a;var r=e.text,o=e.getTexts().toArray(),s=L.a.languages.markdown,i=L.a.tokenize(r,s),u=[],l=o.shift(),p=l,m=0,d=0,h=0;function f(e){return"string"==typeof e?e.length:"string"==typeof e.content?e.content.length:e.content.reduce(function(e,t){return e+f(t)},0)}var b=!0,g=!1,v=void 0;try{for(var y,k=i[Symbol.iterator]();!(b=(y=k.next()).done);b=!0){var w=y.value;l=p,m=d;var O=f(w),j=h+O,E=l.text.length-m,x=O;for(d=m+x;E<x;)p=o.shift(),x=O-E,E=p.text.length,d=x;if("string"!=typeof w){var _={anchor:{key:l.key,offset:m},focus:{key:p.key,offset:d},mark:{type:w.type}};u.push(_)}h=j}}catch(S){g=!0,v=S}finally{try{b||null==k.return||k.return()}finally{if(g)throw v}}return[].concat(Object(c.a)(a),u)}}]),t}(a.Component),P=(n(368),{config:{iceServers:(Object({NODE_ENV:"production",PUBLIC_URL:"/caracara"}).ICE_URLS||V.ICE_URLS).split(";").map(function(e){var t=e.split(","),n=Object(g.a)(t,3),a=n[0],r=n[1],o=n[2];return r&&o?{urls:a,credential:r,username:o}:{urls:a}})}}),D=function(){var e=Object(b.a)(f.a.mark(function e(t,n){var a,r,o,s,i;return f.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a=n&&n.length>0?n:null,r=Object(A.a)(j.a,a,t),e.next=4,r.initialize();case 4:return o=x()({id:t,stream:function(){return r.replicate()}}),s=r.db.discoveryKey.toString("hex"),i=(Object({NODE_ENV:"production",PUBLIC_URL:"/caracara"}).SIGNAL_URLS||V.SIGNAL_URLS).split(";"),o.join(S()(s,i),P),o.on("connection",function(){var e=Object(b.a)(f.a.mark(function e(t){return f.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r.connect(t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),console.log(e.t0);case 8:case"end":return e.stop()}},e,this,[[0,5]])}));return function(t){return e.apply(this,arguments)}}()),e.abrupt("return",r);case 10:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}(),N={content:{top:"50%",left:"50%",right:"auto",bottom:"auto",marginRight:"-50%",transform:"translate(-50%, -50%)"}},R=function(e){function t(){var e;return Object(u.a)(this,t),(e=Object(p.a)(this,Object(m.a)(t).call(this))).updatePeerValue=function(t){console.log("updatePeerValue",t),e.setState({peerValue:t},function(){e.comm.writeMessage({peerValue:t,username:e.props.username})})},e.comm=null,e.state={peerValue:{text:""},localHistory:[]},e}return Object(d.a)(t,e),Object(l.a)(t,[{key:"componentDidUpdate",value:function(){var e=Object(b.a)(f.a.mark(function e(t,n){var a,r,o,s=this;return f.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=this.props,r=a.username,o=a.draftId,r===t.username){e.next=6;break}return e.next=4,D(r,o);case 4:this.comm=e.sent,this.comm.on("message",function(e){console.log("new message arrival from:",e.username),console.log("new message arrival content:",e.message),console.log("message history:",e.history),s.setState({peerValue:e.message.peerValue,localHistory:[].concat(Object(c.a)(s.state.localHistory),[e.history[0]])})});case 6:case"end":return e.stop()}},e,this)}));return function(t,n){return e.apply(this,arguments)}}()},{key:"componentWillUnmount",value:function(){this.comm.removeAllListeners("message")}},{key:"render",value:function(){var e=this.props,t=e.username;e.draftId;return r.a.createElement(r.a.Fragment,null,r.a.createElement("header",{className:"App-header"},"Caracara ",r.a.createElement("span",{role:"img","aria-label":"caracara bird using a emoji"},"\ud83d\udc27"),r.a.createElement("span",{className:"App-username"},t?"".concat(t," is online"):""),r.a.createElement("div",null,this.comm&&this.comm.db.key?"Draft: ".concat(this.comm.db.key.toString("hex")):"")),r.a.createElement("div",{className:"App-editor"},r.a.createElement(I,{peerValue:this.state.peerValue,updatePeerValue:this.updatePeerValue})),r.a.createElement("aside",{className:"App-history"},"History:",r.a.createElement("ul",null,this.state.localHistory.reverse().map(function(e){return r.a.createElement("li",null,e[0])}))))}}]),t}(a.Component),z=function(e){function t(){var e;return Object(u.a)(this,t),(e=Object(p.a)(this,Object(m.a)(t).call(this))).saveUsername=function(t){var n=t.target;e.setState({username:n.value})},e.state={modalIsOpen:!0,username:""},e.openModal=e.openModal.bind(Object(i.a)(Object(i.a)(e))),e.afterOpenModal=e.afterOpenModal.bind(Object(i.a)(Object(i.a)(e))),e.closeModal=e.closeModal.bind(Object(i.a)(Object(i.a)(e))),e.params=new URLSearchParams(window.location.search),e.draftId=e.params.get("draft"),e}return Object(d.a)(t,e),Object(l.a)(t,[{key:"openModal",value:function(){this.setState({modalIsOpen:!0})}},{key:"afterOpenModal",value:function(){}},{key:"closeModal",value:function(){this.setState({modalIsOpen:!1})}},{key:"render",value:function(e){var t=this;return r.a.createElement("div",{className:"App"},r.a.createElement(w.a,{isOpen:this.state.modalIsOpen,onAfterOpen:this.afterOpenModal,onRequestClose:this.closeModal,style:N,contentLabel:"Set your username"},r.a.createElement("form",null,r.a.createElement("legend",null,"Set your username"),r.a.createElement("input",{type:"text",onChange:this.saveUsername})),r.a.createElement("button",{onClick:this.closeModal},"Enter")),r.a.createElement(v.a,null,r.a.createElement(y.a,{path:"/",render:function(e){return r.a.createElement(R,{username:t.state.username,draftId:t.draftId})}})))}}]),t}(a.Component);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));s.a.render(r.a.createElement(z,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})}},[[151,2,1]]]);
//# sourceMappingURL=main.2930b606.chunk.js.map